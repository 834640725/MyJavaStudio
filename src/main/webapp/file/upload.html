<html>
<head>
<meta charset="UTF-8">
	<link href="../resources/css/common.css" rel="stylesheet" />
	<script src="../resources/js/jquery-2.1.4.js"></script>
	
</head>

<body>
<h2>HTML5异步上传文件，带进度条</h2>
	<form method="post" enctype="multipart/form-data">
		其他需要提交的信息：<input type="text" name="aaa"/><br/><br/>
		选择要上传的文件：<br/>
		<input type="file" name="file" size="60" /><br/>
		<input type="file" name="file" size="60" /><br/>
		<br/> <!-- <input type="submit" value="开始上传" /> -->
	</form>
	
	<div id="imgPreview">
	图片预览：<!-- <img id="img" style="width:100;height:100"/> -->
	</div>
	
	<br/><br/>
	<input type="button" value="上传吧" onclick="upload()"/>
	<br/><br/>
	上传进度：
	<progress></progress><br/>
	<p id="progress">bytes</p>
</body>

<script>
	function upload(){
		$("form").submit();
	}

	$(':file').change(function() {
		var file = this.files[0];
		name = file.name;
		size = file.size;
		type = file.type;
		url = window.URL.createObjectURL(file);
		$("#img").attr("src", url);
		$("#info").html("fileName: "+ name + "; size: " + size + "; type: "+ type + " url: " + url);
		
	});

	function upload() {
		var formData = new FormData($('form')[0]);
		
		$.ajax({
			url: "http://localhost:8080/MyJavaStudio/servlet/file/upload",
			type: "POST",
			data: formData,
			xhr: function(){
				myXhr = $.ajaxSettings.xhr();
				if(myXhr.upload){ // check if upload property exists
					// for handling the progress of the upload
					myXhr.upload.addEventListener('progress',progressHandlingFunction, false); 
				}
				return myXhr;
			},
			success: function(result){
				$("#result").html(result.data);
			},
			contentType: false,
			processData: false
		});
	}		

	function progressHandlingFunction(e) {
		if (e.lengthComputable) {
			$('progress').attr({value : e.loaded, max : e.total});
			var percent = e.loaded/e.total*100;
			$('#progress').html(e.loaded + "/" + e.total+" bytes. " + percent.toFixed(2) + "%");
		}
	}

		/* $("form").attr('action',
				"http://localhost:8080/MyJavaStudio/servlet/file/upload");
		$("form").submit(); */
</script>

</html>
