<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<link href="../resources/css/common.css" rel="stylesheet" />
	<script src="../resources/js/jquery-2.1.4.js"></script>
	
</head>

<body>
	<h2>HTML5异步上传文件，带进度条</h2>
	<form method="post" enctype="multipart/form-data">
		其他需要提交的信息：<input type="text" name="otherInfo"/><br/><br/>
		选择要上传的文件：<br/>
		<input type="file" name="file" /><span></span><br/>
		<input type="file" name="file" /><span></span><br/>
		<br/> <!-- <input type="submit" value="开始上传" /> -->
	</form>
	
	<div id="imgPreview">
	<!-- 图片预览： <img id="img" style="width:100;height:100"/> -->
	</div>
	
	<br/><br/>
	<input type="button" value="上传吧" onclick="upload()"/>
	<br/><br/>
	上传进度：
	<progress></progress><br/>
	<p id="progress">0 bytes</p>
	<p id="info"></p>
</body>

<script>
	var totalSize = 0;
	
	/* function upload(){
		$("form").submit();
	} */

	//绑定所有type=file的元素的onchange事件的处理函数
	$(':file').change(function() {
		var file = this.files[0]; //假设file标签没打开multiple属性，那么只取第一个文件就行了
		name = file.name;
		size = file.size;
		type = file.type;
		url = window.URL.createObjectURL(file);
		//$("#img").attr("src", url);
		
		$(this).next().html("文件名：" + name + " 文件类型：" + type + " 文件大小：" + size + " url: " + url);
		
		
		totalSize += size;
		
		$("#info").html("总大小: " + totalSize);
		
	});

	function upload() {
		var formData = new FormData($('form')[0]);
		
		$.ajax({
			url: "http://localhost:8080/MyJavaStudio/servlet/file/upload",
			type: "POST",
			data: formData,
			xhr: function(){
				myXhr = $.ajaxSettings.xhr();
				if(myXhr.upload){ //检查upload属性是否存在
					//绑定progress事件的回调函数
					myXhr.upload.addEventListener('progress',progressHandlingFunction, false); 
				}
				return myXhr; //xhr对象返回给jQuery使用
			},
			success: function(result){
				$("#result").html(result.data);
			},
			contentType: false,
			processData: false
		});
	}		

	//上传进度回调函数：
	function progressHandlingFunction(e) {
		if (e.lengthComputable) {
			$('progress').attr({value : e.loaded, max : e.total});
			var percent = e.loaded/e.total*100;
			$('#progress').html(e.loaded + "/" + e.total+" bytes. " + percent.toFixed(2) + "%");
		}
	}

		/* $("form").attr('action',
				"http://localhost:8080/MyJavaStudio/servlet/file/upload");
		$("form").submit(); */
</script>

</html>
